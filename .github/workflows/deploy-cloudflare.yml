name: Deploy to Cloudflare

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  WRANGLER_VERSION: 4.46.0
  WEB_PROJECT_NAME: applymonitor-web
  DB_NAME: applymonitor-db
  RUSTFLAGS: "-C target-feature=+atomics,+bulk-memory,+mutable-globals"

jobs:
  deploy-web:
    name: ðŸš€ Deploy Web to Cloudflare Pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: ðŸ§© Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "cloudflare-rust-cache"
          cache-all-crates: true

      - name: ðŸ“¦ Install Dioxus CLI
        run: cargo install dioxus-cli --locked

      - name: ðŸ—ï¸ Build web client (Dioxus)
        working-directory: packages/web
        run: dx bundle --release --web

      - name: âš¡ Install Wrangler
        run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}

      - name: ðŸ§­ Ensure Cloudflare Pages project exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if ! wrangler pages project list --json | jq -e ".[] | select(.name == \"${{ env.WEB_PROJECT_NAME }}\")" >/dev/null; then
            echo "Creating new Cloudflare Pages project: ${{ env.WEB_PROJECT_NAME }}"
            wrangler pages project create "${{ env.WEB_PROJECT_NAME }}" --production-branch=main
          else
            echo "âœ… Cloudflare Pages project '${{ env.WEB_PROJECT_NAME }}' already exists"
          fi

      - name: ðŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION }}
          workingDirectory: packages/web
          command: pages deploy dist --project-name=${{ env.WEB_PROJECT_NAME }}

  deploy-api:
    name: âš™ï¸ Deploy API to Cloudflare Workers
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    needs: deploy-web  # deploy API after web succeeds

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: ðŸ§© Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "cloudflare-rust-cache"
          cache-all-crates: true

      - name: ðŸ“¦ Install worker-build
        run: cargo install worker-build --locked

      - name: âš¡ Install Wrangler
        run: npm install -g wrangler@${{ env.WRANGLER_VERSION }}

      - name: ðŸ—ƒï¸ Ensure Cloudflare D1 database exists
        working-directory: packages/api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          DB_LIST=$(wrangler d1 list --json)
          if echo "$DB_LIST" | jq -e ".[] | select(.name == \"${{ env.DB_NAME }}\")" >/dev/null; then
            DB_ID=$(echo "$DB_LIST" | jq -r ".[] | select(.name == \"${{ env.DB_NAME }}\") | .uuid")
            echo "âœ… Found existing DB: $DB_ID"
          else
            echo "ðŸ§± Creating new D1 database: ${{ env.DB_NAME }}"
            DB_OUTPUT=$(wrangler d1 create "${{ env.DB_NAME }}" --json)
            DB_ID=$(echo "$DB_OUTPUT" | jq -r ".uuid")
          fi

          # Update wrangler.toml safely
          sed -i.bak "s/database_id = \".*\"/database_id = \"$DB_ID\"/" wrangler.toml
          rm -f wrangler.toml.bak

      - name: ðŸ“œ Apply D1 migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION }}
          workingDirectory: packages/api
          command: d1 migrations apply ${{ env.DB_NAME }} --remote

      - name: ðŸš€ Deploy API Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: ${{ env.WRANGLER_VERSION }}
          workingDirectory: packages/api
          command: deploy --env production
