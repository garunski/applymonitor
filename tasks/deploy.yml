version: '3'

tasks:
  prod:
    desc: Test deploy both API Worker and web to the same Pages project
    cmds:
      - task: prod:build-api
      - task: prod:deploy-pages
      - task: prod:deploy-api

  prod:build-api:
    desc: Build API Worker
    dir: "{{.API_DIR}}/main"
    internal: true
    cmds:
      - worker-build

  prod:deploy-pages:
    desc: Deploy Pages
    internal: true
    cmds:
      - |
        echo "ğŸš€ Testing deployment of API Worker + Web to same Pages project"
        echo ""
        echo "ğŸ“¦ Web assets already built in target/dx/web/release/web/public"
        echo ""
        echo "ğŸ”§ Step 1: Deploying static assets to Cloudflare Pages..."
        wrangler pages deploy target/dx/web/release/web/public \
          --project-name=applymonitor-web-production
        echo ""

  prod:deploy-api:
    desc: Deploy API Worker
    dir: "{{.API_DIR}}/main"
    internal: true
    cmds:
      - |
        echo ""
        echo "ğŸ”§ Step 2: Deploying API Worker..."
        echo "Note: After deploying, attach the Worker to the Pages project via:"
        echo "  - Cloudflare Dashboard: Pages > applymonitor-web-production > Settings > Functions"
        echo "  - Or use the Pages API to attach the Worker programmatically"
        echo ""
        wrangler deploy --env production
        echo ""
        echo "âœ… Deployment complete!"

  prod:deploy-gmail-scanner:
    desc: Deploy Gmail Scanner Worker
    dir: "{{.API_DIR}}/gmail-scanner"
    internal: true
    cmds:
      - |
        echo ""
        echo "ğŸ”§ Deploying Gmail Scanner Worker..."
        wrangler deploy --env production
        echo ""
        echo "âœ… Gmail Scanner Worker deployment complete!"

  db:migrate-local:
    desc: Apply database migrations to local remote D1 database
    dir: "{{.API_DIR}}/main"
    cmds:
      - wrangler d1 migrations apply DB --env local --remote

  db:migrate-prod:
    desc: Apply database migrations to production D1 database
    dir: "{{.API_DIR}}/main"
    cmds:
      - wrangler d1 migrations apply DB --env production --remote

  db:reset-local:
    desc: Reset the local remote D1 database by dropping all tables and reapplying migrations
    dir: "{{.API_DIR}}/main"
    cmds:
      - |
        echo "ğŸ—‘ï¸  Dropping all tables from local database..."
        ../../../tasks/drop_all_tables.sh --env local --remote || echo "Tables may not exist"
        echo "ğŸ†• Reapplying all migrations..."
        wrangler d1 migrations apply DB --env local --remote
        echo "âœ… Local database reset complete!"

  db:reset-prod:
    desc: Reset the production D1 database by dropping all tables and reapplying migrations
    dir: "{{.API_DIR}}/main"
    cmds:
      - |
        echo "âš ï¸  WARNING: This will reset the PRODUCTION database!"
        echo "ğŸ—‘ï¸  Dropping all tables from production database..."
        ../../../tasks/drop_all_tables.sh --env production --remote || echo "Tables may not exist"
        echo "ğŸ†• Reapplying all migrations..."
        wrangler d1 migrations apply DB --env production --remote
        echo "âœ… Production database reset complete!"
