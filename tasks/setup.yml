version: '3'

tasks:
  setup:
    desc: Set up Cloudflare resources (D1 database, Pages project, Worker, Custom domain)
    cmds:
      - task: setup:d1
      - task: setup:pages
      - task: setup:domain
      - task: setup:verify

  setup:d1:
    desc: Create D1 database if it doesn't exist
    dir: "{{.API_DIR}}"
    cmds:
      - |
        echo "Creating D1 database: applymonitor-db"
        wrangler d1 create applymonitor-db || echo "Database may already exist"
        echo "âœ… Done! Update wrangler.toml with the database_id from the output above"

  setup:pages:
    desc: Create Cloudflare Pages project if it doesn't exist
    cmds:
      - |
        echo "Checking for Cloudflare Pages project: applymonitor-web-production"
        if wrangler pages project list --json 2>/dev/null | jq -e '.[] | select(.name == "applymonitor-web-production")' >/dev/null; then
          echo "âœ… Cloudflare Pages project 'applymonitor-web-production' already exists"
        else
          echo "Creating Cloudflare Pages project: applymonitor-web-production"
          wrangler pages project create applymonitor-web-production --production-branch=main
          echo "âœ… Created Cloudflare Pages project"
        fi
        echo ""
        echo "ðŸ“ To add custom domain 'applymonitor.com' to Pages:"
        echo "   Go to Cloudflare Dashboard > Pages > applymonitor-web-production > Custom domains"
        echo "   Or run: wrangler pages domain add applymonitor.com --project-name=applymonitor-web-production"

  setup:domain:
    desc: Add custom domain applymonitor.com to Pages and Worker
    cmds:
      - |
        echo "ðŸŒ Setting up custom domain: applymonitor.com"
        echo ""
        echo "ðŸ“„ Adding domain to Pages project..."
        echo "Note: Custom domains for Pages must be added via Cloudflare Dashboard:"
        echo "      Pages > applymonitor-web-production > Custom domains > Set up a custom domain"
        echo ""
        echo "ðŸ“„ Adding domain to Worker..."
        echo "Note: Worker routes are configured in wrangler.toml"
        echo "      Custom domain should be added via Cloudflare Dashboard:"
        echo "      Workers & Pages > applymonitor-api-production > Triggers > Custom Domains"
        echo ""
        echo "âœ… Domain setup instructions provided"

  setup:verify:
    desc: Verify all Cloudflare resources are set up
    cmds:
      - |
        echo ""
        echo "ðŸ” Verifying Cloudflare resources..."
        echo ""
        echo "D1 Databases:"
        wrangler d1 list --json | jq -r '.[] | "  âœ… \(.name) (ID: \(.uuid))"'
        echo ""
        echo "Pages Projects:"
        wrangler pages project list --json 2>/dev/null | jq -r '.[] | "  âœ… \(.name)"'
        echo ""
        echo "âœ… Setup verification complete"

