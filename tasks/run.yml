version: '3'

tasks:
  tailwind:dev:
    desc: Build Tailwind CSS in watch mode
    dir: "packages/tailwind"
    cmds:
      - |
        if [ ! -d "node_modules" ]; then
          echo "Installing Tailwind dependencies..."
          npm install
        fi
      - npm run generate:logos
      - npm run dev

  tailwind:build:
    desc: Build Tailwind CSS once
    dir: "packages/tailwind"
    cmds:
      - |
        if [ ! -d "node_modules" ]; then
          echo "Installing Tailwind dependencies..."
          npm install
        fi
      - npm run build

  web:
    desc: Run the Dioxus web app on port 9000
    dir: "{{.WEB_DIR}}"
    deps: [tailwind:build]
    cmds:
      - dx serve --port 9000
    env:
      DX_ENVIRONMENT: development

  api:setup:
    desc: Install worker-build if not available
    cmds:
      - |
        if ! command -v worker-build &> /dev/null; then
          echo "Installing worker-build..."
          cargo install worker-build --locked
        else
          echo "worker-build is already installed"
        fi

  db:
    desc: Apply migrations to local remote D1 database
    dir: "{{.API_DIR}}/main"
    cmds:
      - |
        if ! wrangler d1 migrations list DB --env local --remote 2>/dev/null | grep -q "No migrations to apply"; then
          echo "y" | wrangler d1 migrations apply DB --env local --remote 2>/dev/null || true
        fi

  api:
    desc: Run the Cloudflare Workers API on port 8000
    deps: [api:setup, db]
    dir: "{{.API_DIR}}/main"
    cmds:
      - wrangler dev --port 8000 --env local

  gmail-scanner:
    desc: Run the Gmail Scanner Worker on port 8001
    deps: [api:setup, db]
    dir: "{{.API_DIR}}/gmail-scanner"
    cmds:
      - wrangler dev --port 8001 --env local

